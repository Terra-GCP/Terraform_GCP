version: 0.2
env:
  variables:
    TF_VERSION: "1.0.6"
phases:
  install:
    commands:
      - cd /modules-disks-wise
      - curl -L -o opa https://github.com/open-policy-agent/opa/releases/download/v0.11.0/opa_linux_amd64
      - chmod 755 ./opa
  build:
    commands:
      - terraform plan -out tf.plan
      - terraform show -json tf.plan > tfplan.json 
      - opa eval --format pretty --data policy.rego --input tfplan.json "data.terraform"
  post_build:
    commands:
      - echo "OPA Test completed on `date`"